<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=242549DE40032C3C747A873E54852767" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:FooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=6E35A38929E376AA4B24625BCA315D6F" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>C# : Windows Service in console mode for debug and admin</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>C# : Windows Service in console mode for debug and admin</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            C#, Windows Service
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Windows Service
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">5/3/2015</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">MIT</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/C-Service-Windows-in-8a08bd63">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Introduction</h1>
<p>This is the source code for the example of the Wiki Technet article :&nbsp;<a href="http://social.technet.microsoft.com/wiki/contents/articles/30957.c-windows-service-in-console-mode-for-debug-and-admin.aspx">C# : Windows Service in console mode for debug
 and admin</a>.</p>
<h1><span>Building the Sample</span></h1>
<p>To build the sample you need Visual Studio 2013.</p>
<p><span style="font-size:20px; font-weight:bold">Description</span></p>
<p><span>The TechNet article provide a solution to facilitate debugging and administration of Windows Service created in C#/.Net.</span></p>
<p>The idea is to convert the Windows Service to console application to provide to behaviors.</p>
<h2>Debugging the Windows Service</h2>
<p>When we detect the debugging mode, we simulate the service execution. This permit to debug the startup service, that we can't do when we attach the debugger to the service. For this we detect if we are attached to a debugger and is we are in interactive
 mode :</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">    // In interactive and debug mode ?
    if (Environment.UserInteractive &amp;&amp; <a class="libraryLink" href="https://code.msdn.microsoft.com/C-Service-Windows-in-8a08bd63/https://code.msdn.microsoft.com/C-Service-Windows-in-8a08bd63/https://msdn.microsoft.com/en-US/library/System.Diagnostics.Debugger.IsAttached.aspx"  title="Auto generated link to System.Diagnostics.Debugger.IsAttached">System.Diagnostics.Debugger.IsAttached</a>)
    {
        // Simulate the services execution
        RunInteractiveServices(ServicesToRun);
    }
    else
    {
        // Normal service execution
        ServiceBase.Run(ServicesToRun);
    }
</pre>
<div class="preview">
<pre class="csharp">&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;In&nbsp;interactive&nbsp;and&nbsp;debug&nbsp;mode&nbsp;?</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">if</span>&nbsp;(Environment.UserInteractive&nbsp;&amp;&amp;&nbsp;<a class="libraryLink" href="https://code.msdn.microsoft.com/C-Service-Windows-in-8a08bd63/https://code.msdn.microsoft.com/C-Service-Windows-in-8a08bd63/https://msdn.microsoft.com/en-US/library/System.Diagnostics.Debugger.IsAttached.aspx"  title="Auto generated link to System.Diagnostics.Debugger.IsAttached">System.Diagnostics.Debugger.IsAttached</a>)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Simulate&nbsp;the&nbsp;services&nbsp;execution</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RunInteractiveServices(ServicesToRun);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">else</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__com">//&nbsp;Normal&nbsp;service&nbsp;execution</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceBase.Run(ServicesToRun);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p>&quot;RunInteractiveServices&quot; is a method wich start the service execution.</p>
<p>&nbsp;</p>
<h2>Manage the service</h2>
<p>To helping management, we use the console application to provide commands from arguments to install, uninstall, start and stop the service. To install and start a service we need to execute folowing the command line:</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>Bash/shell</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">bash</span>
<pre class="hidden">&quot;%SystemRoot%\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe&quot; WinServiceTest.exe
net start &quot;My Service&quot;
</pre>
<div class="preview">
<pre class="bash"><span class="bash__string">&quot;%SystemRoot%\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe&quot;</span>&nbsp;WinServiceTest.exe&nbsp;
net&nbsp;start&nbsp;<span class="bash__string">&quot;My&nbsp;Service&quot;</span>&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">and to stop and uninstall</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>Bash/shell</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">bash</span>
<pre class="hidden">net stop &quot;My Service&quot;
&quot;%SystemRoot%\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe&quot; /u WinServiceTest.exe
</pre>
<div class="preview">
<pre class="bash">net&nbsp;stop&nbsp;<span class="bash__string">&quot;My&nbsp;Service&quot;</span>&nbsp;
<span class="bash__string">&quot;%SystemRoot%\Microsoft.NET\Framework\v4.0.30319\InstallUtil.exe&quot;</span>&nbsp;/u&nbsp;WinServiceTest.exe&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">So by using arguments with the console application we can do this more easly like</div>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>Bash/shell</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">bash</span>
<pre class="hidden">WinServiceTest.exe install start
WinServiceTest.exe uninstall stop
</pre>
<div class="preview">
<pre class="bash">WinServiceTest.exe&nbsp;<span class="bash__commands">install</span>&nbsp;start&nbsp;
WinServiceTest.exe&nbsp;uninstall&nbsp;stop&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">For this we use the the 'ManagedClass' and the 'ServiceController' classes.</div>
<div class="endscriptcode"></div>
<div class="endscriptcode">
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">// Having an install command ?
if (HasCommand(args, &quot;install&quot;))
{
    ManagedInstallerClass.InstallHelper(new String[] { typeof(Program).Assembly.Location });
    hasCommands = true;
}
// Having a start command ?
if (HasCommand(args, &quot;start&quot;))
{
    foreach (var service in ServicesToRun)
    {
        ServiceController sc = new ServiceController(service.ServiceName);
        sc.Start();
        sc.WaitForStatus(ServiceControllerStatus.Running, TimeSpan.FromSeconds(10));
    }
    hasCommands = true;
}
// Having a stop command ?
if (HasCommand(args, &quot;stop&quot;))
{
    foreach (var service in ServicesToRun)
    {
        ServiceController sc = new ServiceController(service.ServiceName);
        sc.Stop();
        sc.WaitForStatus(ServiceControllerStatus.Stopped, TimeSpan.FromSeconds(10));
    }
    hasCommands = false;
}
// Having an uninstall command ?
if (HasCommand(args, &quot;uninstall&quot;))
{
    ManagedInstallerClass.InstallHelper(new String[] { &quot;/u&quot;, typeof(Program).Assembly.Location });
    hasCommands = true;
}
</pre>
<div class="preview">
<pre class="csharp"><span class="cs__com">//&nbsp;Having&nbsp;an&nbsp;install&nbsp;command&nbsp;?</span>&nbsp;
<span class="cs__keyword">if</span>&nbsp;(HasCommand(args,&nbsp;<span class="cs__string">&quot;install&quot;</span>))&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ManagedInstallerClass.InstallHelper(<span class="cs__keyword">new</span>&nbsp;String[]&nbsp;{&nbsp;<span class="cs__keyword">typeof</span>(Program).Assembly.Location&nbsp;});&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;hasCommands&nbsp;=&nbsp;<span class="cs__keyword">true</span>;&nbsp;
}&nbsp;
<span class="cs__com">//&nbsp;Having&nbsp;a&nbsp;start&nbsp;command&nbsp;?</span>&nbsp;
<span class="cs__keyword">if</span>&nbsp;(HasCommand(args,&nbsp;<span class="cs__string">&quot;start&quot;</span>))&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">foreach</span>&nbsp;(var&nbsp;service&nbsp;<span class="cs__keyword">in</span>&nbsp;ServicesToRun)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceController&nbsp;sc&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;ServiceController(service.ServiceName);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc.Start();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc.WaitForStatus(ServiceControllerStatus.Running,&nbsp;TimeSpan.FromSeconds(<span class="cs__number">10</span>));&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;hasCommands&nbsp;=&nbsp;<span class="cs__keyword">true</span>;&nbsp;
}&nbsp;
<span class="cs__com">//&nbsp;Having&nbsp;a&nbsp;stop&nbsp;command&nbsp;?</span>&nbsp;
<span class="cs__keyword">if</span>&nbsp;(HasCommand(args,&nbsp;<span class="cs__string">&quot;stop&quot;</span>))&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="cs__keyword">foreach</span>&nbsp;(var&nbsp;service&nbsp;<span class="cs__keyword">in</span>&nbsp;ServicesToRun)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServiceController&nbsp;sc&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;ServiceController(service.ServiceName);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc.Stop();&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sc.WaitForStatus(ServiceControllerStatus.Stopped,&nbsp;TimeSpan.FromSeconds(<span class="cs__number">10</span>));&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;hasCommands&nbsp;=&nbsp;<span class="cs__keyword">false</span>;&nbsp;
}&nbsp;
<span class="cs__com">//&nbsp;Having&nbsp;an&nbsp;uninstall&nbsp;command&nbsp;?</span>&nbsp;
<span class="cs__keyword">if</span>&nbsp;(HasCommand(args,&nbsp;<span class="cs__string">&quot;uninstall&quot;</span>))&nbsp;
{&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ManagedInstallerClass.InstallHelper(<span class="cs__keyword">new</span>&nbsp;String[]&nbsp;{&nbsp;<span class="cs__string">&quot;/u&quot;</span>,&nbsp;<span class="cs__keyword">typeof</span>(Program).Assembly.Location&nbsp;});&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;hasCommands&nbsp;=&nbsp;<span class="cs__keyword">true</span>;&nbsp;
}&nbsp;
</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
</div>
<p>&nbsp;</p>
<h1><span>Source Code Files</span></h1>
<ul>
<li>Folder &quot;<strong>Article</strong>&quot; : this folder contains the base of the technet article in french and in english.
</li><li>Folder &quot;<strong>WinServiceTest\WinServiceTest</strong>&quot; the project source code for the french version.
</li><li>Folder &quot;<strong>WinServiceTest\WinServiceTest-en</strong>&quot; the project source code for the english version.
</li><li>Solution &quot;<strong>WinServiceTest\WinServiceTest.sln</strong>&quot; the solution containing the two projects.
</li></ul>
<h1>More Information</h1>
<p>The original article was write in french version, so the images and some source files generated by Visual Studio are in french.</p>
<p>The complete description of the source code is explains in the&nbsp;Wiki Technet article&nbsp;<a href="http://social.technet.microsoft.com/wiki/contents/articles/30957.c-windows-service-in-console-mode-for-debug-and-admin.aspx">C# : Windows Service in console
 mode for debug and admin</a>.</p>

</div>


    </div>
</body>
</html>
