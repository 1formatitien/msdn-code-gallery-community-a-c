<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=916470BEE9F8DB824145BA6856ECF377" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/d1a9ff7d-6f02-4739-a4a5-20cea616d387Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=CE3B6C265D415C9B3DABD6520782A3F7" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>ASP.NET 4.5 MVC5 Custom Identity With Stronger Password Storaging</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>ASP.NET 4.5 MVC5 Custom Identity With Stronger Password Storaging</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            ASP.NET MVC 5, ASP.NET Identity
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Security, ASP.NET MVC 5, ASP.NET Identity, Password Hashing
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Web
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">4/9/2014</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p>ASP.NET 4.5 MVC 5 was released a few months ago and it brought a load of new features, one of them being ASP.NET Identity which is the replacement of the former Simple Membership and Membership before that.</p>
<p>If you create a basic MVC 5 application you will get a project with a basic implementation of this Identity that makes calls to a UserManager object to deal with authentication. This object then communicates with a UserStore object that deals with the database
 through a UserContext object.</p>
<p>Microsoft made it really easy and this will get you through most of the basic things you may want to do, but as always, we don't want the default implementations, we want to make customizations. Therefore I developed a custom Identity implementation with
 the specific goal of customizing the way passwords are dealt with.</p>
<p>By default, ASP.NET hashes passwords using 5000 rounds of the&nbsp;PBKDF2 (Password-Based Key Derivation Function 2), which is a key stretching algorithm and they used a class named Rfc2898DeriveBytes that has a HMACSHA256 hashing algorithm&nbsp;which is
 not considered to be very secure anymore.</p>
<p>In my implementation I used a modded&nbsp;&nbsp;implementation of Rfc2898DeriveBytes&nbsp;by Ian Harris,&nbsp;that uses the way more secure&nbsp;HMACSHA512&nbsp;hashing algorithm and also added the possibility of setting the number of rounds, which is way
 more secure and lasting. In the future, as computer power evolves, you can &nbsp;increase the number of rounds for an increased security.</p>
<p>Besides PBKDF2 I also integrated BCrypt by&nbsp;Damien Miller and SCrypt by&nbsp;Colin Percival which are widely more accepted as more secure hashing algorithms.</p>
<p>First of all I created a new MVC5 project that gave me all the basic AccountController methods.</p>
<p>After that I started by creating my custom Identity provider so I replaced the UserManager with a&nbsp;<strong>tmUserManager</strong>&nbsp;that implements an&nbsp;<strong>ItmUserManager</strong>&nbsp;with all the basic methods shown below.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/1.png"><img class="alignnone size-full x_x_wp-image-52" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/1.png" alt="ItmUserManager" width="700" height="164"></a></p>
<p>This is the object to have on the AccountController replacing the current implementation. I have also added IoC that has nothing to do with my point what so ever but it just looks nice.</p>
<p><strong>Before</strong></p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/2.png"><img class="alignnone size-full x_x_wp-image-53" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/2.png" alt="AccountController Default" width="700" height="63"></a></p>
<p><strong>After</strong></p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/3.png"><img class="alignnone size-full x_x_wp-image-54" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/3.png" alt="AccountController Custom" width="398" height="101"></a></p>
<p>After this I implemented my own UserStore to which I called&nbsp;<strong>tmUserStore</strong>&nbsp;running a&nbsp;<strong>tmIdentityUser</strong>. This&nbsp;<strong>tmUserStore</strong>&nbsp;also has a&nbsp;<strong>tmUserContext</strong>&nbsp;object to communicate
 with a SQL database through a&nbsp;<strong>tmDbContext</strong>.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/4.png"><img class="alignnone size-full x_x_wp-image-55" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/4.png" alt="tmUserStore" width="681" height="101"></a></p>
<p>Now for the fun part!</p>
<p>I implemented a mechanism to let you use different Hashing Algorithms&nbsp;that let's you easily add and configure how you want them to behave. The project already has ready to use:&nbsp;<strong>BCrypt</strong>;&nbsp;<strong>SCrypt</strong>;&nbsp;<strong>PBKDF2</strong>;</p>
<p>So, how does it work?</p>
<p>I have a static class HashingConfig with two public static methods:</p>
<ul>
<li>public static string HashPassword(string password) </li><li>public static bool VerifyPassword(string password, string hash) </li></ul>
<p>The configurations of these algorithms can be done via the Web.config in the appSettings section and in this example, SCrypt is enabled and it is set for 2^16 rounds, all the others are commented.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/21.png"><img class="alignnone size-full x_x_wp-image-73" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/21.png" alt="HashingConfig Hashing Configurations" width="700" height="311"></a></p>
<p>The values you set here, will then be used when you<span>&nbsp;call the Hashing function on the&nbsp;</span><strong>HashingConfig</strong><span>&nbsp;class that has the following method of extracting the settings defined.</span></p>
<p><img class="alignnone size-full x_x_wp-image-72" src="description/11.png" alt="Web.config Hashing Configurations" width="700" height="531"></p>
<p>Theses settings are then used when you call for a&nbsp;<strong>HashPassword</strong>&nbsp;or&nbsp;<strong>VerifyPassword.</strong></p>
<p><strong>&nbsp;</strong>Usage of HashPassword: Simply call it and send the password to hash.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/8.png"><img class="alignnone size-full x_x_wp-image-61" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/8.png" alt="HashPassword" width="485" height="406"></a></p>
<p>Usage of VerifyPassword: Simply call it and send the password to hash and the previously stored hashed representation of it.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/7.png"><img class="alignnone size-full x_x_wp-image-60" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/7.png" alt="VerifyPassword" width="469" height="472"></a></p>
<p>As you can read on my comments, if you want to add another algorithm, create another case with your implementation and create a class that handles the communication with your algorithm class such as this example for BCrypt below.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/9.png"><img class="alignnone size-full x_x_wp-image-62" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/9.png" alt="BCrypt Example" width="661" height="307"></a></p>
<p>So that leaves me with a nice tree view like the image below where I have put all the back implementation of the hashing algorithms into their respective folders.</p>
<p><a href="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/10.png"><img class="alignnone size-full x_x_wp-image-63" src="http://code.msdn.microsoft.com/ASPNET-45-MVC5-Custom-1a94ab26/description/10.png" alt="Hashing TreeView" width="273" height="273"></a></p>
<p>So that is it!</p>

</div>


    </div>
</body>
</html>
