<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/67b74b86-a273-4ad7-9ed5-0f97276412eaCombined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Creating a MHTML (MIME HTML) document from a webpage</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Creating a MHTML (MIME HTML) document from a webpage</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            MHTML, CDO, MIME
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Document Conversion
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop, Web
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">6/23/2011</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/Creating-a-MHTML-MIME-HTML-61cf5dd1">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<p>I recently had to generate a MHTML (MIME HTML) document from a webpage in .NET. Searching for existing solutions, I found some articles around CDO and IE/Browser object automation but did not find a definite guide. So here is a sample of two different approaches
 for creating a MHTML document from a webpage.</p>
<p>&nbsp;<img src="description/mhtml maker.png" alt="" width="663" height="285"></p>
<h2></h2>
<h2>CDO Approach</h2>
<p>The main advantage of using CDO is that it has a built-in method for creating a MHTML document.</p>
<p></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">Message message = new MessageClass {MimeFormatted = true};
message.CreateMHTMLBody(url, CdoMHTMLFlags.cdoSuppressNone, &quot;&quot;, &quot;&quot;);</pre>
<div class="preview">
<pre id="codePreview" class="csharp">Message&nbsp;message&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;MessageClass&nbsp;{MimeFormatted&nbsp;=&nbsp;<span class="cs__keyword">true</span>};&nbsp;
message.CreateMHTMLBody(url,&nbsp;CdoMHTMLFlags.cdoSuppressNone,&nbsp;<span class="cs__string">&quot;&quot;</span>,&nbsp;<span class="cs__string">&quot;&quot;</span>);</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p></p>
<p>CDO will automatically embed images and external css files. If you have to embed other external resources, you will have to do some coding. Here is an example for embedding javascript:</p>
<p></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">var scriptPart = message.BodyPart.AddBodyPart();
scriptPart.ContentMediaType = &quot;text/javascript&quot;;
scriptPart.Charset = &quot;iso-8859-1&quot;;
scriptPart.ContentTransferEncoding = &quot;quoted-printable&quot;;
scriptPart.Fields[&quot;urn:schemas:mailheader:content-id&quot;].Value = id;
scriptPart.Fields[&quot;urn:schemas:mailheader:content-disposition&quot;].Value = &quot;inline&quot;;
scriptPart.Fields.Update();

var stream = scriptPart.GetDecodedContentStream();
var scriptStream = (IStream)stream;
var scriptContent = _webRequestHelper.GetContent(absoluteScriptUrl);
scriptStream.Write(scriptContent.Content, scriptContent.Content.Length, IntPtr.Zero);
stream.Flush();
stream.Close();

message.HTMLBody = message.HTMLBody.Replace(scriptUrl, &quot;cid:&quot; &#43; id);</pre>
<div class="preview">
<pre id="codePreview" class="csharp">var&nbsp;scriptPart&nbsp;=&nbsp;message.BodyPart.AddBodyPart();&nbsp;
scriptPart.ContentMediaType&nbsp;=&nbsp;<span class="cs__string">&quot;text/javascript&quot;</span>;&nbsp;
scriptPart.Charset&nbsp;=&nbsp;<span class="cs__string">&quot;iso-8859-1&quot;</span>;&nbsp;
scriptPart.ContentTransferEncoding&nbsp;=&nbsp;<span class="cs__string">&quot;quoted-printable&quot;</span>;&nbsp;
scriptPart.Fields[<span class="cs__string">&quot;urn:schemas:mailheader:content-id&quot;</span>].Value&nbsp;=&nbsp;id;&nbsp;
scriptPart.Fields[<span class="cs__string">&quot;urn:schemas:mailheader:content-disposition&quot;</span>].Value&nbsp;=&nbsp;<span class="cs__string">&quot;inline&quot;</span>;&nbsp;
scriptPart.Fields.Update();&nbsp;
&nbsp;
var&nbsp;stream&nbsp;=&nbsp;scriptPart.GetDecodedContentStream();&nbsp;
var&nbsp;scriptStream&nbsp;=&nbsp;(IStream)stream;&nbsp;
var&nbsp;scriptContent&nbsp;=&nbsp;_webRequestHelper.GetContent(absoluteScriptUrl);&nbsp;
scriptStream.Write(scriptContent.Content,&nbsp;scriptContent.Content.Length,&nbsp;IntPtr.Zero);&nbsp;
stream.Flush();&nbsp;
stream.Close();&nbsp;
&nbsp;
message.HTMLBody&nbsp;=&nbsp;message.HTMLBody.Replace(scriptUrl,&nbsp;<span class="cs__string">&quot;cid:&quot;</span>&nbsp;&#43;&nbsp;id);</pre>
</div>
</div>
</div>
<p></p>
<p>The main disadvantages of using CDO are:</p>
<ul>
<li>COM Interop! </li><li>Does not work in 64 bit systems (x64) </li><li>Requires STA (Single Threaded Apartment), so if you use this in an ASP.NET application, you will have to do some threading tricks.
</li></ul>
<p>&nbsp;</p>
<h2><a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Net.Mail.aspx"  title="Auto generated link to System.Net.Mail">System.Net.Mail</a></h2>
<p>You can also create a MHTML document using MailMessage in System.Net.Mail. There is little more work involved but you do not have to deal with COM Interop or 32bit limitation.</p>
<p></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">var message = new MailMessage { From = new MailAddress(&quot;a@a.com&quot;) };
var view = AlternateView.CreateAlternateViewFromString(htmlString.ToString(), new ContentType(&quot;text/html&quot;));
view.TransferEncoding = TransferEncoding.SevenBit;
message.AlternateViews.Add(view);</pre>
<div class="preview">
<pre id="codePreview" class="csharp">var&nbsp;message&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;MailMessage&nbsp;{&nbsp;From&nbsp;=&nbsp;<span class="cs__keyword">new</span>&nbsp;MailAddress(<span class="cs__string">&quot;a@a.com&quot;</span>)&nbsp;};&nbsp;
var&nbsp;view&nbsp;=&nbsp;AlternateView.CreateAlternateViewFromString(htmlString.ToString(),&nbsp;<span class="cs__keyword">new</span>&nbsp;ContentType(<span class="cs__string">&quot;text/html&quot;</span>));&nbsp;
view.TransferEncoding&nbsp;=&nbsp;TransferEncoding.SevenBit;&nbsp;
message.AlternateViews.Add(view);</pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p></p>
<p>You will have to do all the work of detecting external resources, downloading them and then adding them as MimeParts. Here is an example on how to do that:</p>
<p></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">var id = Guid.NewGuid().ToString();

var result = _webRequestHelper.GetContent(absoluteUrl);

var ms = new MemoryStream(result.Content);
var lr = new LinkedResource(ms, new ContentType(result.ContentType)) {ContentId = id, TransferEncoding = TransferEncoding.Base64};
resources.Add(lr);

htmlString.Replace(url, &quot;cid:&quot; &#43; id);
</pre>
<div class="preview">
<pre id="codePreview" class="js"><span class="js__statement">var</span>&nbsp;id&nbsp;=&nbsp;Guid.NewGuid().ToString();&nbsp;
&nbsp;
<span class="js__statement">var</span>&nbsp;result&nbsp;=&nbsp;_webRequestHelper.GetContent(absoluteUrl);&nbsp;
&nbsp;
<span class="js__statement">var</span>&nbsp;ms&nbsp;=&nbsp;<span class="js__operator">new</span>&nbsp;MemoryStream(result.Content);&nbsp;
<span class="js__statement">var</span>&nbsp;lr&nbsp;=&nbsp;<span class="js__operator">new</span>&nbsp;LinkedResource(ms,&nbsp;<span class="js__operator">new</span>&nbsp;ContentType(result.ContentType))&nbsp;<span class="js__brace">{</span>ContentId&nbsp;=&nbsp;id,&nbsp;TransferEncoding&nbsp;=&nbsp;TransferEncoding.Base64<span class="js__brace">}</span>;&nbsp;
resources.Add(lr);&nbsp;
&nbsp;
htmlString.Replace(url,&nbsp;<span class="js__string">&quot;cid:&quot;</span>&nbsp;&#43;&nbsp;id);&nbsp;
</pre>
</div>
</div>
</div>
<p></p>
<p>One little caveat of this approach is that there isn&rsquo;t an easy way to get to the MHTML document content unless you intend to send it in an email. So I had to write a small extension method using reflection to pull it out as a byte array.</p>
<p></p>
<div class="scriptcode">
<div class="pluginEditHolder" pluginCommand="mceScriptCode">
<div class="title"><span>C#</span></div>
<div class="pluginLinkHolder"><span class="pluginEditHolderLink">Edit</span>|<span class="pluginRemoveHolderLink">Remove</span></div>
<span class="hidden">csharp</span>
<pre class="hidden">var sendMethod = typeof(MailMessage).GetMethod(&quot;Send&quot;, BindingFlags.Instance | BindingFlags.NonPublic);

sendMethod.Invoke(message, BindingFlags.Instance | BindingFlags.NonPublic, null, new[] { GetMailWriter(ms), false }, null);

private static object GetMailWriter(MemoryStream ms)
{
    var assembly = typeof(MailMessage).Assembly;
    var mailWriterType = assembly.GetType(&quot;System.Net.Mail.MailWriter&quot;);
    var mailWriterConstructorInfo = mailWriterType.GetConstructor(BindingFlags.Instance | BindingFlags.NonPublic, null, new[] { typeof(Stream) }, null);

    return mailWriterConstructorInfo.Invoke(new object[] { ms });
}</pre>
<div class="preview">
<pre id="codePreview" class="js"><span class="js__statement">var</span>&nbsp;sendMethod&nbsp;=&nbsp;<span class="js__operator">typeof</span>(MailMessage).GetMethod(<span class="js__string">&quot;Send&quot;</span>,&nbsp;BindingFlags.Instance&nbsp;|&nbsp;BindingFlags.NonPublic);&nbsp;
&nbsp;
sendMethod.Invoke(message,&nbsp;BindingFlags.Instance&nbsp;|&nbsp;BindingFlags.NonPublic,&nbsp;null,&nbsp;<span class="js__operator">new</span>[]&nbsp;<span class="js__brace">{</span>&nbsp;GetMailWriter(ms),&nbsp;false&nbsp;<span class="js__brace">}</span>,&nbsp;null);&nbsp;
&nbsp;
private&nbsp;static&nbsp;object&nbsp;GetMailWriter(MemoryStream&nbsp;ms)&nbsp;
<span class="js__brace">{</span>&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">var</span>&nbsp;assembly&nbsp;=&nbsp;<span class="js__operator">typeof</span>(MailMessage).Assembly;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">var</span>&nbsp;mailWriterType&nbsp;=&nbsp;assembly.GetType(<span class="js__string">&quot;System.Net.Mail.MailWriter&quot;</span>);&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">var</span>&nbsp;mailWriterConstructorInfo&nbsp;=&nbsp;mailWriterType.GetConstructor(BindingFlags.Instance&nbsp;|&nbsp;BindingFlags.NonPublic,&nbsp;null,&nbsp;<span class="js__operator">new</span>[]&nbsp;<span class="js__brace">{</span>&nbsp;<span class="js__operator">typeof</span>(Stream)&nbsp;<span class="js__brace">}</span>,&nbsp;null);&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;<span class="js__statement">return</span>&nbsp;mailWriterConstructorInfo.Invoke(<span class="js__operator">new</span>&nbsp;object[]&nbsp;<span class="js__brace">{</span>&nbsp;ms&nbsp;<span class="js__brace">}</span>);&nbsp;
<span class="js__brace">}</span></pre>
</div>
</div>
</div>
<div class="endscriptcode">&nbsp;</div>
<p></p>
<p>This sample does not include code for handling css background images and iframes but it shouldn&rsquo;t be too hard to modify the sample to handle those.</p>

</div>


    </div>
</body>
</html>
