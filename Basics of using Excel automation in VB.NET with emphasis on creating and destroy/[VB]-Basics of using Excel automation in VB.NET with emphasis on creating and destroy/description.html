<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Header,0:HeaderFooterSprite,0:Header.NonMtps;/Areas/Centers/Themes/StandardDevCenter/Content:0&amp;amp;v=15CA4F640FE303BB139D3B851A140E56" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="https://i-msdn.sec.s-msft.com/Combined.css?resources=0:Footer,0:HeaderFooterSprite,0:Footer.NonMtps,1:NewFooterSock,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;v=90EAE36970292C42654B7D481764CD4E" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Basics of using Excel automation in VB.NET with emphasis on creating and destroy</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="https://i1.code.msdn.s-msft.com/content/common/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="https://i1.code.msdn.s-msft.com/content/common/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Basics of using Excel automation in VB.NET with emphasis on creating and destroy</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Microsoft Office Excel, VB.Net
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            Office Automation
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop, Data
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">1/22/2016</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="https://code.msdn.microsoft.com/Basics-of-using-Excel-4453945d">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<h1>Introduction</h1>
<div><span style="font-size:small">This sample provides code showing how to properly work with objects to access Excel files, WorkBooks and Worksheets and when finishes properly displose of used objects without the need to call the Garbage Collector</span><em>.<br>
&nbsp;</em></div>
<h1><span>Building the Sample</span></h1>
<div><span style="font-size:small">Load the project into Visual Studio 2010 or higher, select Build project. If you receive and error that a reference is missing, under project properties, reference tab look for a reference to Microsoft.Office.Interop.Excel.
 If there is text indicating the reference is not found do the following. Staying on the reference tab select add new reference, on the .NET tab (not the COM tab)&nbsp;select Microsoft.Office.Interop.Excel. At this point the project will build. Running the
 project the first time will create an Excel file in the same folder as your application executable with the file name of MyFile1.xlsx. If you are using an earlier version of Excel prior to Excel 2007 then change the file name to MyFile1.xls. The file name
 is in a public module named UtilityRoutines, variable name is ExcelFileName.</span></div>
<p>&nbsp;</p>
<div><span style="font-size:small">This is what you will see if the reference can't be found as per above, you need to remove this reference and add yours in</span></div>
<p>&nbsp;</p>
<div><img id="109034" src="description/NF.png" alt="" width="783" height="92"></div>
<div><span style="font-size:small"><br>
Note that all code has <span style="background-color:#ffff00">Option Strict On</span>.</span></div>
<div><span style="font-size:small"><span style="color:#ff0000"><strong>&nbsp;</strong></span></span></div>
<div><span style="font-size:small"><span style="color:#ff0000"><strong>UPDATE 2/18/2014</strong></span> added a C# solution with several examples, open a file, verify a sheet exist, open a file and collect sheet names and an example of reading cells. I will
 continue adding to this C# example as time permits. The main consideration here is that both the VB and C code both dispose of memory exactly the same way.</span></div>
<div><span style="font-size:small">Screen shot from C first project</span><img id="108901" src="description/C1.png" alt="" width="623" height="824"></div>
<div><span style="font-size:20px; font-weight:bold">Description</span></div>
<div><span style="font-family:Calibri; font-size:medium">The primary focus of this article is to show the very basics of working with Excel automation using early binding without the need to call the GC (Garbage Collector) to cleanup and properly dispose of
 objects used to work with Excel automation.<br>
&nbsp;</span></div>
<div><span style="font-family:Calibri; font-size:medium">Why would a developer even care about not calling the garbage collector? To answer this questions let us look at a common requirement I see in many forums. A requirement for the project specifies that
 data displayed to the user (perhaps in a DataGridView) must be exportable to Microsoft Excel. Many times the developer will search the Internet for how to accomplish this task and finds a solution close to what they need. From here, they will tweak the found
 code to suit their requirement to export the data to Excel. The code works great and all seems fine until one day one or more users complain about their machine slowing down. They call their help desk that has the user reboot, which seems to resolve the problem.
 However, this keeps happening several times during their workday. The help desk does some research and learns that this only happens when your application is running. You are called into investigate and quickly discover the problem is with the Excel export
 module. &nbsp;There are what I call cheap several ways to resolve this and the cheap way is to call the GC which for all intense and purposes is fine. Now all of the sudden during a specific period the application crashes and leaves instances of Excel in memory.
 There are two quick solutions, reboot the user&rsquo;s computer or have them kill the orphan instances of Excel in Task Manager under the process tab. A better way would be to code properly in the first place.<br>
&nbsp;</span></div>
<div class="MsoNormal" style="margin:0in 0in 10pt"><span style="font-size:medium"><span style="font-family:Calibri">The best way to code starts without even working with Excel. Before coding, keep the following under consideration. Does the file exist, if
 not create the file. &nbsp;When opening an Excel file check if a specific sheet exists before selecting it. The attached project shows how to do the above using simple assertion, which can circumvent unnecessary run time exceptions, right off the bat.&nbsp;
</span></span></div>
<div class="MsoNormal" style="margin:0in 0in 10pt"><span style="font-family:Calibri; font-size:medium">When coding for Excel you should have Windows Task Manager open, run the code and when completed Excel should not be showing in the process tab of Task
 Manager. When you close the application and Excel instances are removed from Task Manager this is okay if the user only runs this code once. If the user runs the code many times than more instances of Excel are left in memory.</span></div>
<div class="MsoNormal" style="margin:0in 0in 10pt"><span style="font-family:Calibri; font-size:medium">Excerpt from a Microsoft project demonstrating how to correctly cleanup objects dealing with early binding for Excel automation.</span></div>
<div class="MsoNormal" style="margin:0in 0in 10pt"><span style="font-family:Calibri; font-size:medium">Office automation is based on Component Object Model (COM). When you call a COM object of Office from managed code, a Runtime Callable Wrapper (RCW) is
 automatically created. The RCW marshals calls between the .NET application and the COM object. The RCW keeps a reference count on the COM object. If all references have not been released on the RCW, the COM object of Office does not quit and may cause the
 Office application not to quit after your automation.</span></div>
<div class="MsoNormal" style="margin:0in 0in 10pt"><span style="font-family:Calibri; font-size:medium">A good example of this is when there are two periods used to reference a property or method. So the following line of code &ldquo;xlWorkSheet.Range(&quot;A1&quot;).Value&rdquo;
 will cause a reference not to be released. Another example would be to active a worksheet using CType(xlWorkBook.Sheets(1), Excel.Worksheet). To the inexperienced developer neither of these lines of code seem problematic and they do work but will not release
 references.</span></div>
<div class="MsoNormal" style="margin:0in 0in 10pt"><span style="font-family:Calibri; font-size:medium">Instead of getting into deep details, I invite you to download the attached project, run it and then study the code. If you follow the examples for opening
 and reading data, you will be on the right path to writing much better code to access Excel. To demonstrate this there is a good deal more code to prepare the reading of data from Excel. Out of the entire example, code there is but one line of code, which
 calls the GC. This was intentional in that there will be times when keeping to one period in a line of code will elude you so when this happens use the method shown to release this object.</span></div>
<div><span style="line-height:115%; font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;; font-size:medium">One more item, a class has been included to retrieve sheet names and name range names. This can be done in OleDb but OleDb sorts names a-z meaning if there is a requirement
 for natural ordering of sheet names in a control on your form OleDb will not work. The class uses early binding Excel automation yet if you wanted too OpenXML SDK offers the same functionality as my class but only works on Excel 2007 or higher.</span></div>
<div><img id="108903" src="description/V1.png" alt="" width="700" height="504">&nbsp;</div>
<h1><span>Source Code Files</span></h1>
<div><span style="font-size:small">Everything source code wise is in the attached VS2010 project.</span>&nbsp;</div>
<h1>More Information</h1>
<div><em>&nbsp;</em>&nbsp;</div>

</div>


    </div>
</body>
</html>
